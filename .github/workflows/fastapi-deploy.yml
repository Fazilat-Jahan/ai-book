name: Deploy FastAPI Backend to Cloud Provider
    2 
    3 on:
    4   push:
    5     branches:
    6       - main # Set this to your default branch
    7     paths:
    8       - 'backend/**' # Trigger only on changes in the backend directory
    9   workflow_dispatch:
   10 
   11 env:
   12   PROJECT_ID: " " # Placeholder for your GCP project ID or other cloud provider variable
   13   GAR_LOCATION: us-central1 # Adjust for your preferred region
   14   SERVICE_NAME: ai-book-backend # Choose a unique service name
   15 
   16 jobs:
   17   deploy:
   18     name: Build and Deploy
   19     runs-on: ubuntu-latest
   20     permissions:
   21       contents: 'read'
   22       id-token: 'write'
   23 
   24     steps:
   25       - name: Checkout
   26         uses: actions/checkout@v4
   27 
   28       # This step assumes you are deploying to Google Cloud Run.
   29       # Adapt these steps for your chosen cloud provider (e.g., AWS ECR/Lambda, Azure Container Apps).
   30       - name: Authenticate Google Cloud
   31         if: ${{ env.PROJECT_ID != '' }}
   32         uses: 'google-github-actions/auth@v2'
   33         with:
   34           workload_identity_provider: 'projects/${{ env.PROJECT_ID 
      }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider' # Replace with your Workload   
      Identity Provider
   35           service_account: 'github-actions@${{ env.PROJECT_ID }}.iam.gserviceaccount.com' # Replace with your   
      service account email
   36 
   37       - name: Set up Docker Buildx
   38         uses: docker/setup-buildx-action@v3
   39 
   40       - name: Login to Google Artifact Registry
   41         if: ${{ env.PROJECT_ID != '' }}
   42         uses: 'docker/login-action@v3'
   43         with:
   44           registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'
   45           username: '_json_key'
   46           password: '${{ secrets.GCP_SA_KEY }}' # Replace with your service account key or other cloud provider 
      secret
   47 
   48       - name: Build and push Docker image
   49         if: ${{ env.PROJECT_ID != '' }}
   50         run: |
   51           docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }} /
      {{ env.SERVICE_NAME }}:${{ github.sha }}" ./backend
   52           docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ 
      env.SERVICE_NAME }}:${{ github.sha }}"
   53 
   54       - name: Deploy to Google Cloud Run
   55         if: ${{ env.PROJECT_ID != '' }}
   56         uses: 'google-github-actions/deploy-cloudrun@v2'
   57         with:
   58           service: ${{ env.SERVICE_NAME }}
   59           region: ${{ env.GAR_LOCATION }}
   60           image: '${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{      
      env.SERVICE_NAME }}:${{ github.sha }}'
   61           # Add any other Cloud Run specific configurations here, e.g.,
   62           # env_vars: |
   63           #   QDRANT_URL=${{ secrets.QDRANT_URL }}
   64           #   QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
   65           #   GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
   66           # no_traffic: true
   67           # port: 8000
   68           # revision_suffix: ${{ github.sha }}
   69           # ...
